# redis的3种集群化方案

redis有3种集群化方案：主从复制，哨兵模式，集群

## 1.主从复制

redis的replication机制允许slave从master那里通过网络传输拷贝到完整的数据备份，从而达到主从机制。

原理：
	（1）从服务器连接主服务器，发送sync命令；
	（2）从服务器接收到sync命令后，开始执行bgsave命令生产RDB文件并使用缓冲区记录此后执行的所有命令；
	（3）主服务器bgsave执行完后，向所有从服务器发送快照文件，并在发送期间继续记录被执行的写命令；
	（4）从服务器收到筷子文件后丢弃所有旧数据，载入收到的快照
	（5）主服务器快照发送完毕后开始向从服务器发生缓冲区写命令
	（6）从服务器完成对快照的载入，开始接收命令请求，并执行来自主服务器缓冲区的写命令（从服务器初始化完成）
	（7）主服务器每执行一个写命令就会向从服务器发送相同的写命令，从服务器接收并执行收到的写命令（从服务器初始化完成后的操作）
优点：
	
	（1）主从复制，主机会自动将数据同步到从机，可以进行读写分离
	
	（2）为了分摊master的读操作压力，slave服务器可以为客户端提供只读操作，写服务由master完成
	
	（3）slave同样可以接受其他slaves的连接和同步请求，这样可以有效分摊master的同步压力
	
	（4）master server是以非阻塞方式为slaves提供服务的，在master-slave同步期间客户端仍然可以提交查询或修改请求
	
	（5）slave 同样以非阻塞方式完成数据同步。同步期间，如果有客户端提交查询请求，redis返回之前数据
	
缺点：

	（1）redis不具备自动容错和恢复功能，主机从机的宕机都会导致前端部分读写请求失败，需要等待机器重启或手动切换前段ip才能恢复
	
	（2）主机宕机，宕机前有部分数据未能及时同步到从机，切换ip后还会引入数据不一致的问题，降低系统可用性
	
	（3）redis较难支持在线扩容，在集群容量达到上限时在线扩容变得很复杂
	
	（4）主机宕机，导致服务提供写服务，只能提供读服务
	
	
master节点挂了以后，redis就不能对外提供写服务了，因为剩下的slave不能成为master，这个缺点影响是很大的，尤其是对生产环境来说，
是一刻都不能停止服务的，所以一般的生产坏境是不会单单只有主从模式的，所以有了下面的sentinel模式
	
## 2.哨兵模式

当主服务器中断服务后，可以将一个从服务器升级为主服务器，以便继续提供服务，但这个过程需要人工介入。为此redis2.8以后提供了哨兵工具来实现自动化的系统监控和
故障恢复功能

哨兵的作用是监控redis系统的运行状态:

(1)监控主服务器和从服务器是否正常运行
(2)主服务器出现故障时自动将从服务器转换为主服务器


哨兵工作方式：
	（1）每个哨兵进程以每秒一次频率向整个集群中的master主服务器，slaver从服务器及其他sentinel进程发生一个ping命令
	（2）如果一个实例距离最后一次有效回复ping命令时间超过down-after-milliseconds选项指定的值，则这个实例被sentinel进程标记为下线
	（3）如果一个master主服务器被标记为主观下线，则正在监视这个master主服务器的所有sentinel进程要以每秒一次的频率确认master主服务器的确进入下线
	（4）当有足够数量的sentinel进程在指定时间范围内确认master主服务器进入下线状态master被标记为下线
	（5）一般情况下，每个sentinel进程以每10s一次的频率向集群中所有master主服务器，slave从服务器发生info命令
	（6）当Master主服务器被 Sentinel（哨兵）进程标记为客观下线（ODOWN）时，Sentinel（哨兵）进程向下线的 Master主服务器的所有 
	Slave从服务器发送 INFO 命令的频率会从 10 秒一次改为每秒一次。
	（7）若没有足够数量的 Sentinel（哨兵）进程同意 Master主服务器下线， Master主服务器的客观下线状态就会被移除。若 Master主服务器
	重新向 Sentinel（哨兵）进程发送 PING 命令返回有效回复，Master主服务器的主观下线状态就会被移除



优点：

	（1）哨兵模式是基于主从模式的，主从的优点，哨兵模式都有
	（2）主从可以自动切换，系统更健壮，可用性更高
	
缺点：

	（1）redis教难支持在线扩容，在集群容量达到上限时在线扩容会变得很复杂

## 3.redis集群

redis的哨兵模式基本已经可以实现高可用，读写分离，但是在这种模式下每台redis服务器相同的数据，很
浪费内存，所以在redis3.0上加入cluster模式，实现redis的分布式存储，也就是每台redis节点存储不同
内容。

redis集群采用无中心结构，特点：

（1）所有redis节点彼此互联（ping-pong机制），内部使用二进制协议优化传输速度和带宽

（2）节点的fail是通过集群中超过半数的节点检测失效时才生效

（3）客户端与redis节点直连，不需要中间代理层，客户端不需要连接集群所有节点，连接集群中任何
一个可用节点

工作方式：

在redis的每个节点上，都有这么个东西一个是槽（slot）,取值范围是：0-16383.另一个是cluster,可用
理解为一个集群管理插件。当我们存取key到达的时候，redis会根据crc16算法得出一个结果，然后把结果对
16384求余，这样每个key都会对应一个编号在0-16383之间的槽，通过这个值，去找到对应的插槽所对应的节点，
进行存取操作。

为了保证高可用，redis-cluster集群引入主从模式，一个主节点对应一个一个或多个从节点，当主节点宕机时，
会启用从节点。当其他主节点ping一个主节点A,如果半数以上的主节点与A通信超时，那么认为主节点A宕机了。
如果主节点A和它的从节点A1都宕机了，那么该集群就无法再提供服务了。


自动将数据进行分片，每个 master 上放一部分数据
提供内置的高可用支持，部分 master 不可用时，还是可以继续工作的

支撑N个redis master node，每个master node都可以挂载多个slave node
高可用，因为每个master都有salve节点，那么如果mater挂掉，redis cluster这套机制，就会自动将某个slave切换成master



目前一般在选型上来说：

体量较小时，选择 Redis Sentinel ，单主 Redis 足以支撑业务。
体量较大时，选择 Redis Cluster ，通过分片，使用更多内存。

Redis Sentinel 着眼于高可用，在 master 宕机时会自动将 slave 提升为 master ，继续提供服务。
Redis Cluster 着眼于扩展性与高可用，在单个 Redis 内存不足时，使用Cluster 进行分片存储。
	
	
	





























